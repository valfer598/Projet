import openpyxl as op
import difflib
import unicodedata
import os

# === PARAMÈTRES ===
nom_fichier = "LB3_SiteX.xlsx"  # <-- à adapter
nom_feuille = "LB3"

wb = op.load_workbook(nom_fichier)
ws = wb[nom_feuille]

machines = []  # Liste finale

# === FONCTIONS UTILITAIRES ===

def ajout_machine():
    """Crée un dictionnaire machine vide avec les champs normalisés."""
    return {
        'NOM_DU_SITE': None,
        'BATIMENT': None,
        'ETAGE': None,
        'LT': None,
        'BAIE': None,
        'CONSTRUCTEUR': None,
        'MODELE': None,
        'SENS INSTALLATION': None,
        'ETIQUETTE': None,
        'POSITION V': None,
        'POSITION H': None,
        'SN': None,
        'CAB': None,
        'REMARQUE': None
    }

def nettoyer(val):
    if val:
        return str(val).strip().replace("\n", "").replace("\r", "").lower()
    return ""

def normaliser(texte):
    texte = texte.lower().strip()
    texte = unicodedata.normalize("NFKD", texte).encode("ASCII", "ignore").decode("utf-8")
    return texte

def detecter_approx(texte, liste_mots, seuil=0.8):
    if not texte:
        return None
    texte_normalise = normaliser(texte)
    mots = texte_normalise.split()
    liste_normalisee = [normaliser(m) for m in liste_mots]
    for mot in mots:
        match = difflib.get_close_matches(mot, liste_normalisee, n=1, cutoff=seuil)
        if match:
            return match[0]
    return None

def extraire_modele_depuis_prefixe(texte, liste_prefixes):
    if not texte:
        return None
    mots = normaliser(texte).split()
    for i, mot in enumerate(mots):
        for prefixe in liste_prefixes:
            if normaliser(mot).startswith(normaliser(prefixe)):
                return " ".join(mots[i:])
    return None

def chercher_valeur_apres_libelle(libelle):
    libelle_nettoye = nettoyer(libelle)
    for i in range(1, ws.max_row + 1):
        for j in range(1, ws.max_column):
            val = ws.cell(row=i, column=j).value
            if nettoyer(val) == libelle_nettoye:
                return ws.cell(row=i, column=j + 1).value
    return None

def Etage(val):
    val = nettoyer(val).upper()
    correspondances = {
        "RDC": "RDC",
        "1": "R+1", "R+1": "R+1",
        "2": "R+2", "R+2": "R+2",
        "3": "R+3", "R+3": "R+3"
    }
    return correspondances.get(val, f"Étage inconnu ({val})")

# === PARAMÈTRES DE RECHERCHE ===

constructeurs = ["Cisco", "HP", "Dell", "Juniper", "Fortinet", "Palo Alto"]
modeles = ["C9300", "DL380", "EX4300", "FG60", "PA-220"]

# === EXTRACTION DES MACHINES ===

for j in range(1, ws.max_column + 1):
    nom_baie = ws.cell(row=1, column=j).value
    if not nom_baie:
        continue

    for i in range(2, ws.max_row + 1):
        val_baie = ws.cell(row=i, column=j).value
        position = ws.cell(row=i, column=j - 1).value if j > 1 else None
        sens_installation = ws.cell(row=i, column=j + 1).value if j < ws.max_column else None

        texte = str(val_baie).strip() if val_baie else ""
        constructeur = detecter_approx(texte, constructeurs) or "vide"
        modele = extraire_modele_depuis_prefixe(texte, modeles) or "vide"

        machine = ajout_machine()
        machine["BAIE"] = nom_baie
        machine["POSITION V"] = position
        machine["SENS INSTALLATION"] = sens_installation
        machine["CONSTRUCTEUR"] = constructeur
        machine["MODELE"] = modele
        machines.append(machine)

# === CHAMPS COMMUNS ===

val_bat = chercher_valeur_apres_libelle("batiment")
val_etage = chercher_valeur_apres_libelle("etage")

for machine in machines:
    machine["BATIMENT"] = val_bat or "Inconnu"
    machine["ETAGE"] = Etage(val_etage) if val_etage else "Inconnu"
    machine["LT"] = nom_feuille
    machine["NOM_DU_SITE"] = os.path.splitext(os.path.basename(nom_fichier))[0]

# === TRI PAR POSITION V ===

def key_tri(machine):
    try:
        return int(machine["POSITION V"])
    except (TypeError, ValueError):
        return float("inf")

machines.sort(key=key_tri)

# === AFFICHAGE FINAL ===

for m in machines:
    print(
        f"[{m['POSITION V']}] "
        f"Baie: {m['BAIE']} | "
        f"Constructeur: {m['CONSTRUCTEUR']} | "
        f"Modèle: {m['MODELE']} | "
        f"Sens: {m['SENS INSTALLATION']}"
    )
